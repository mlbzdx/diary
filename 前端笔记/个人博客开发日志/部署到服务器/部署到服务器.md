## 购买服务器：

略

## 连接服务器

### 使用 `ssl` 连接

控制台`ssh`连接命令:

```bash
//一般情况服务器会开启22端口供开发者访问
ssh -p 22 主机名@IP地址
//示例
ssh -p 22 root@47.108.233.198
```

出现一句：
Are you sure you want to continue connecting (yes/no)?

输入：yes 回车 

输入密码，连接成功

![](https://img-blog.csdnimg.cn/20190102143914159.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dhbmdndWNoYW8=,size_16,color_FFFFFF,t_70)

退出连接，输入指令`exit`即可。

如果不正常退出后，发生如下报错：WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! 

![](https://img-blog.csdnimg.cn/20190102143425660.png)

此报错是由于远程的主机的公钥发生了变化导致的。 
`ssh`服务是通过公钥和私钥来进行连接的，它会把每个曾经访问过计算机或服务器的公钥（public key），记录在`~/.ssh/known_hosts` 中，当下次访问曾经访问过的计算机或服务器时，`ssh`就会核对公钥，如果和上次记录的不同，OpenSSH会发出警告。

如何解决？

方法一：使用命令清除所连接的IP：

```bash
ssh-keygen -R XX.XX.XX.XX 
```

其中，XX.XX.XX.XX为之前连接时的网段IP。

方法二：直接在本地编辑文件，删除`ssh`配置：

要清除SSH连接中的特定主机（例如IP地址，例如47.108.233.198）的记录，您可以编辑您的`~/.ssh/known_hosts`文件，该文件存储了您连接过的远程主机的主机密钥信息。以下是清除该特定IP地址的步骤：

1. 打开终端或命令行窗口。

2. 使用文本编辑器（如`nano`、`vim`、`emacs`或`notepad`等）打开`~/.ssh/known_hosts`文件。在终端中，可以使用以下命令：

   对于Linux/macOS：

   ```
   bashCopy code
   nano ~/.ssh/known_hosts
   ```

   对于Windows的OpenSSH客户端：

   ```
   bashCopy code
   notepad C:\Users\<your_username>\.ssh\known_hosts
   ```

3. 使用文本编辑器查找包含IP地址 "47.108.233.198" 的行。这通常是以主机名或IP地址开始的行。

4. 删除包含该IP地址的整行。在编辑器中，通常可以使用删除或剪切命令来执行此操作。

5. 保存文件并退出编辑器。在`nano`编辑器中，按`Ctrl + O`保存，然后按`Ctrl + X`退出。在其他编辑器中，请按照编辑器的保存和退出指令来完成。

现在，再次尝试使用SSH连接到该IP地址，SSH将不再提示主机密钥变更警告，并且会将新的密钥信息添加到`known_hosts`文件。

### 通过第三方工具连接

`finalshell`是一个控制台工具，可以通过`ssh`连接控制远程服务器以及虚拟机，并传输文件。

`finalshell`的下载与使用参考文档：https://blog.csdn.net/GoodburghCottage/article/details/130575387

`finalshell`与远程服务器连接中断，删除连接管理中的连接，重新设置并进行连接。

## 安装 Node.js  

CentOS官方已计划停止维护CentOS Linux项目，阿里云上CentOS Linux公共镜像来源于CentOS官方，当CentOS Linux停止维护后，阿里云将会同时停止对该操作系统的支持。

具体参阅：*https://help.aliyun.com/document_detail/347584.html?spm=5176.11346930configuration.0.0.284e5ca3pjg7iY*



这里谢老师选择了它家自研的 Alibaba Cloud Linux 2.1903 LTS 64，因为做了很多优化，而且全面兼容RHEL/CentOS生态，并且这也是官方所提供的一个替代方案

![image-20220329115351056](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-035351.png)



修改了操作系统镜像后，安装 Node.js 没有一点问题。

参阅：*https://help.aliyun.com/document_detail/172788.html* 的部署Node.js环境（Alibaba Cloud Linux 2）

安装 Node.js 的途中，遇到了：

>fatal: unable to access 'https://github.com/cnpm/nvm.git/': Encountered end of file

```js
原因:阿里云服务器未开启443端口
执行以下的代码：
需要开启防火墙 systemctl start firewalld
firewall-cmd --zone=public --add-port=443/tcp --permanent # 添加 443 端口访问
firewall-cmd --reload # 重新加载让配置生效
firewall-cmd --zone=public --query-port=443/tcp 查看开启情况，返回 yes 说明已开启。
```

对应的解决方案可以参阅：https://www.cnblogs.com/pangya/p/15735974.html

## 安装 MongoDB 

由于我们更换了操作系统，所以安装 `Mongodb` 的方式也和之前有所不同。

首先需要明确的一点：

Alibaba Cloud Linux 2 对应的是 CentOS7

Alibaba Cloud Linux 3 对应的是 CentOS8

#### 添加yum源

我这里使用的是yum命令安装，需要先添加yum源：

```js
vi /etc/yum.repos.d/mongodb-org-5.0.repo
```

然后将如下内容添加进去：

```js
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
```

> 在 vi 中，按键盘的 i 键是插入内容，插入完毕后按 ESC 退出，然后输入 :wq 保存

按照官方文档添加了yum源文件，但是当执行`yum install -y mongodb-org`命令的时候报错了：

```js
Error: Failed to download metadata for repo 'mongodb-org-5.0': Cannot download repomd.xml: Status code: 404 for https://repo.mongodb.org/yum/redhat/3/mongodb-org/5.0/x86_64/repodata/repomd.xml
```

解决办法就是将`$releasever`变量直接修改为Centos的版本 7，如下：

```js
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/7/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
```

操作截图如下：

![image-20220329122049124](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042049.png)

修改完后再次执行如下命令：

```js
yum install -y mongodb-org
```

MongoDB就能安装成功了。

## 启动 `mongodb` 服务连接数据库

安装完成后，使用`systemctl`命令启动MongoDB服务：

```js
systemctl start mongod  #启动
systemctl status mongod #查看状态
systemctl restart mongod #重新启动
```

具体操作如下图：

![image-20220329122256430](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042256.png)

通过查看状态命令，很多信息都能看到。

启动失败参考 ： https://blog.csdn.net/ATRI_/article/details/127805441

## 上传本地数据库数据至服务器

> **命令行导出**:
>
> 注意！通过命令导出时，确保命令已经在全局环境里进行了配置或者直接在命令工具可执行文件所在文件目录使用终端执行该命令。

### **本地开发环境中的数据备份**

`mongodump` 是 MongoDB 提供的一个命令行工具，用于将 MongoDB 数据库中的数据导出到文件系统中的备份目录。

下面是命令的各个参数的解释：

- `-h dbhost`：指定 MongoDB 数据库的主机地址。你需要替换 `dbhost` 为实际的主机地址，例如 `localhost` 或远程服务器的 IP 地址。
- `-d dbname`：指定要导出数据的数据库名称。你需要替换 `dbname` 为实际的数据库名称。
- `-o dbdirectory`：指定导出的数据应存储的目录路径。你需要替换 `dbdirectory` 为实际的目录路径。

使用 `mongodump` 命令时，MongoDB 将连接到指定的数据库并将其数据导出到指定的目录中。导出的数据以 BSON（Binary JSON）格式保存，每个集合都会生成一个对应的 BSON 文件。

例如，如果你想将名为 `mydatabase` 的数据库导出到 `/backup` 目录下，可以使用以下命令：

```
mongodump -h localhost -d mydatabase -o /backup
```

执行上述命令后，MongoDB 将连接到本地主机上的 `mydatabase` 数据库，并将数据导出到 `/backup` 目录中。

### **服务端生产环境的数据恢复**

切换到 `/bin` 目录，确保 `mongodb` 服务已经成功启动。

数据备份后就可以将其上传到服务器中，然后进行数据恢复

`mongorestore` 是 MongoDB 提供的一个命令行工具，用于将通过 `mongodump` 命令导出的数据恢复到 MongoDB 数据库中。

下面是命令的各个参数的解释：

- `-h dbhost`：指定 MongoDB 数据库的主机地址。你需要替换 `dbhost` 为实际的主机地址，例如 `localhost` 或远程服务器的 IP 地址。
- `-d dbname`：指定要恢复数据的目标数据库名称。你需要替换 `dbname` 为实际的目标数据库名称。
- `--dir dbdirectory`：指定包含导出数据的目录路径。你需要替换 `dbdirectory` 为实际的导出数据所在的目录路径。

使用 `mongorestore` 命令时，MongoDB 将连接到指定的数据库，并从指定的目录中读取导出的数据文件，将其恢复到目标数据库中的相应集合中。

例如，如果你想将之前通过 `mongodump` 命令导出的数据恢复到名为 `mydatabase` 的数据库中，可以使用以下命令：

```
mongorestore -h localhost -d mydatabase --dir /backup
```

执行上述命令后，MongoDB 将连接到本地主机上的 `mydatabase` 数据库，并从 `/backup` 目录中读取导出的数据文件，将其恢复到目标数据库中。

`mongorestore` 命令在进行数据库恢复、数据迁移或与其他工具进行集成时非常有用。它允许你轻松地将通过 `mongodump` 导出的数据恢复到 MongoDB 数据库中，以便进行数据恢复或迁移操作。

### 启动后端服务器

上传后端服务器项目，进入安装项目依赖，运行 `npm start`

## 远程连接

接下来我们来远程连接，记得先把阿里云的安全组的对应端口打开，如下图：

![image-20220329122530816](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042531.png)

点击【配置规则】

![image-20220329122610980](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042611.png)

添加 27017 端口，不把这个端口打开，后期本地电脑无法远程连接数据库

![image-20220329122705011](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042705.png)

首先在云端系统输入 mongo，连接上云端的数据库

![image-20220329122827638](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042827.png)

步骤和上一个文档一样

为了权限接入可用，必须确保有一个用户是 *`userAdmin`* 或者 *`userAdminAnyDatabase`* 的角色在 *admin* 数据库里。
因此，我们首先创建用户 *root* 用户在 *admin* 数据库里，代码如下：

```js
use admin # 切换 admin 数据库
db.createUser({user:"root",pwd:"123456",roles:[{role:"userAdminAnyDatabase",db: "admin"}]})
```

具体操作如下图：

![image-20220329122940139](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-042940.png)

在 *`mongodb`* 中 *admin* 数据库是一个特别的数据库，这个数据库的用户，可以访问 *`mongodb`* 中的所有数据库。所以接下来在 *admin* 数据库上面使用刚才的超级管理员登录，对应代码如下：

```
use amdin
db.auth("root","123456")
```

具体操作如下：

![image-20220329123147776](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-043147.png)

之后为其他数据库设置用户，步骤也是一样的，首先切换到其他数据库，然后创建用户。

```js
use 数据库名
db.createUser({user:"用户名",pwd:"密码",roles:[{role:"read",db: "数据库名"},{role:"readWrite",db:"数据库名"}]})
```

具体操作如下图所示：

![image-20220329123632429](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-043633.png)

最后执行

```js
db.auth("用户名","密码")
```

具体操作如下图：

![image-20220329123729455](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-043730.png)

返回 *1*，说明登录成功。

至此，我们就在 mysite 数据库上面添加了一个用户，并且设置了账号和密码。



接下来我们来修改 `mongodb` 的配置文件

```js
vi /etc/mongod.conf
```

主要就是将 `bingIp` 修改为 0.0.0.0 ，这样我们本地的电脑才能访问到

![image-20220329130403519](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-050403.png)

之后重新启动一下 `mongodb`，重启命令：

```js
systemctl restart mongod
```

然后我们在本地的 robo3T 就能连接云端数据库了

<img src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2022-03-29-062329.png" alt="image-20220329142328981" style="zoom:50%;" />

##  安装 Nginx 静态资源服务器 

### 安装 Nginx 静态资源服务器

（1）下载依赖

`yum -y install pcre*`

`yum -y install openssl*`

（2）下载 wget（类似于迅雷，用来下载文件的）

`yum install wget`

（3）下载 nginx

`wget http://nginx.org/download/nginx-1.21.1.tar.gz`

（4）解压

`tar zxvf nginx-1.21.1.tar.gz`

（5）进入到解压后的目录，编译

`./configure`

编译报错处理参考：https://blog.csdn.net/a11101171/article/details/41622843

（6）安装

`make install`

安装完毕后，会在同级目录生成一个 nginx 的目录，这个才是我们的服务器目录

nginx 常用命令：

- nginx：启动

- nginx -v：查看版本

- nginx -s stop：停止

- nginx -s reload：重启

## 打包项目工程上传服务器 

打包前台代码：

```js
npm run build
```

打包后台代码：

```js
npm run build:prod
```

将打包好的前台代码放入 nginx 的 html 目录下，将打包好的后台代码放入到 nginx/html/admin 目录下

修改 nginx 的配置文件，该文件位于 conf 目录下的 nginx.conf，添加代理设置：

```js
location / {
    root   html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

location /api {
  proxy_pass http://127.0.0.1:7001;
}

location /res {
  proxy_pass http://127.0.0.1:7001;
}

location /static {
  proxy_pass http://127.0.0.1:7001;
}
```

## 进程守护

在 Linux 中，可以输入：

```js
nohup command &
```

来把进程挂起，这样即使我们退出了远程连接，也能够继续保持进程。

使用示例：

```js
nohup npm start &
```

挂起进程之后，使用 *exit* 命令来退出远程连接。

`mongodb`的进程守卫可以通过配置文件中的 `fork`来进行，但是需要注意配置fork的同时需要配置

` pidFilePath`。`pidFilePath`只需要在 `/var/run/mongodb/mongod.pid` 路径下创建一个 `pid`文件即可，不用写入内容，因为 `mongodb`在开启进程时会自动将 `pid` 写入。

```yaml
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# Where and how to store data.
storage:
  dbPath: /var/lib/mongo
  journal:
    enabled: true

#process
processManagement:
  fork: true                                                # fork and run in background
  pidFilePath: /var/run/mongodb/mongod.pid                  # location of pidfile
  timeZoneInfo: /usr/share/zoneinfo
#  engine:
#  wiredTiger:
# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.

security:
  authorization: enabled
#operationProfiling:
#replication:
#sharding:
## Enterprise-Only Options
#auditLog:
#snmp:
```

因为在配置文件中写入了

```yaml
security:
  authorization: enabled
```

所以现在数据库的访问以及需要用户的账号密码才能访问，下面介绍数据库怎样创建用户进行数据库加密。

## 数据库加密

为了权限接入可用，必须确保有一个用户是 *`userAdmin`* 或者 *`userAdminAnyDatabase`* 的角色在 *admin* 数据库里。
因此，我们首先创建用户 *root* 用户在 *admin* 数据库里，代码如下：



```js
use admin # 切换 admin 数据库
db.createUser({user:"root",pwd:"123456",roles:[{role:"userAdminAnyDatabase",db: "admin"}]})
```



具体操作如下图：



![image-20210812093119060](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-12-013119.png)

> 注：*db* 可以查看当前所使用的数据库



![image-20210812093151829](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-12-013151.png)



接下来在其他数据库上面创建用户，但是一定要注意先在 *admin* 数据库上面使用刚才的超级管理员登录，再进行其他数据库用户创建的创建。

对应代码如下：



```js
use amdin
db.auth("root","123456")
```



在 *mongodb* 中 *admin* 数据库是一个特别的数据库，这个数据库的用户，可以访问 *mongodb* 中的所有数据库。



如果要为其他数据库设置用户，步骤也是一样的，首先切换到其他数据库，然后创建用户



```js
use 数据库名
db.createUser({user:"用户名",pwd:"密码",roles:[{role:"read",db: "数据库名"},{role:"readWrite",db:"数据库名"}]})
```



![image-20210812093225943](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-12-013226.png)



最后执行



```js
 db.auth("用户名","密码")
```



![image-20210812093306323](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2021-08-12-013307.png)



返回 *1*，说明登录成功。



至此，我们就在数据库上面添加了一个用户，并且设置了账号和密码。



远程数据库连接时，需要输入账号以及密码。


接下来就是在你的服务器端代码里面，使用 *mongoose* 的时候，连接的是有权限的数据库，所以需要修改连接字符串：



```js
连接字符串修改为：mongodb://username:password@ip:port/database?authSource=admin

例如：mongodb://testadmin:testadmin123@88.888.88.888:27017/testmongodb?authSource=admin
# 参数说明
# testadmin 用户名称
# testadmin123 用户密码
# 88.888.88.888 服务器地址
# 27017 端口号码
# testmongodb 连接的数据库
# ?authSource=admin 权限来源
# 至此，可以通过 mongoose 连接数据库
```

