> 第三方库：`log4js` https://log4js-node.github.io/log4js-node/index.html

```mermaid
graph LR;
安装导入log4js-->配置log4js-->获取log4js实例-->记录日志-->关闭日志记录
```



## 简介：

log4js 是一个流行的 JavaScript 日志记录库，它提供了灵活的日志记录功能，可用于浏览器和 Node.js 环境。

log4js 具有以下主要特点：

1. **多种日志级别**：log4js 支持多种日志级别，包括 DEBUG、INFO、WARN、ERROR 和 FATAL。您可以根据需要选择适当的日志级别来记录不同严重程度的日志信息。
2. **日志输出器**：log4js 支持不同类型的日志输出器，例如控制台输出、文件输出、数据库存储等。您可以根据需求配置适当的输出器来保存日志信息。
3. **日志格式化**：log4js 允许您自定义日志的格式，包括时间戳、日志级别、日志消息等。您可以根据需求定义自己的日志格式，以便更好地理解和分析日志信息。
4. **日志追踪**：log4js 支持日志追踪功能，可以跟踪日志消息的来源。这对于调试和故障排除非常有用，可以帮助您确定日志消息是从哪个位置记录的。
5. **配置文件**：log4js 允许您使用配置文件来定义日志记录的行为。通过配置文件，您可以指定日志级别、输出器、格式等设置，以及其他高级配置选项。

无论是在前端还是后端开发中，log4js 都是一个强大且灵活的日志记录工具，它可以帮助您更好地管理和分析应用程序的日志信息。

## 安装与导入

**安装：**

```bash
npm install log4js
```

**导入：**

```javascript
const log4js = require("log4js");
```

## 配置 `log4js`

配置 `log4js` 需要调用 `log4js.configure(object || string)`方法。

### 配置方法

``log4js.configure(object || string)`` 是 log4js 库中的一个方法，用于配置 log4js 的行为。它接受两种参数，字符串和 JavaScript 对象。

当参数为字符串时，必须为配置文件路径的字符串。`log4js`会根据字符串中的路径找到配置文件(该配置文件可以是JSON 格式的文件或 JavaScript 模块文件)。

当参数为对象时，需要传入一个 `javascript`的配置对象。

####  参数：配置对象

在 log4js 中，配置对象（Configuration Object）用于指定日志记录的行为，包括输出器、格式、日志级别等设置。配置对象是一个包含特定属性的 JavaScript 对象，您可以使用它来定义 log4js 的配置。

以下是 log4js 配置对象的一些常见属性：

1. **`appenders`**：这是一个对象，用于定义日志的输出器。输出器决定了日志消息将被发送到哪里，例如控制台、文件、数据库等。您可以定义多个输出器，并为每个输出器指定特定的类型和配置。

   例如，以下配置定义了一个控制台输出器和一个文件输出器：

   ```javascript
   appenders: {
     console: { type: 'console' },
     file: { type: 'file', filename: 'logs/app.log' }
   }
   ```

2. **categories**：这是一个对象，用于定义日志记录器的类别。类别是一种逻辑组织方式，可以根据需要为不同的模块或文件创建不同的类别。每个类别可以关联一个或多个输出器，并指定日志级别。

   例如，以下配置将默认类别关联到控制台和文件输出器，并将日志级别设置为 `debug`：

   ```javascript
   categories: {
     default: { appenders: ['console', 'file'], level: 'debug' }
   }
   ```

3. **levels**：这是一个对象，用于定义自定义日志级别。log4js 默认提供了 DEBUG、INFO、WARN、ERROR 和 FATAL 这些级别，但您可以根据需要定义自己的级别。

   例如，以下配置定义了一个名为 `'custom'` 的自定义日志级别：

   ```javascript
   levels: {
     custom: { value: 50000, colour: 'purple' }
   }
   ```

4. **`disableClustering`**：这是一个布尔值，用于指定是否禁用 log4js 的集群模式。当设置为 `true` 时，log4js 不会创建多个工作进程来处理日志记录。

   ```javascript
   disableClustering: true
   ```

5. **pm2**：这是一个布尔值，用于指定是否在使用 PM2 进程管理器时启用 PM2 日志集成。当设置为 `true` 时，log4js 将与 PM2 集成，以便在 PM2 日志中显示正确的进程 ID。

   ```javascript
   pm2: true
   ```

> 注意：配置对象必须至少定义一个默认的输出器 和一个默认的记录器类别。如果配置无效，Log4js 将抛出异常。

#### 认识输出器

在 log4js 中，输出器（`appender`）用于定义日志的输出目标。以下是一些常见的输出器配置选项：

1. `type`（必需）：指定输出器的类型。常见的类型包括：
   - `"console"`：将日志输出到控制台。
   - `"file"`：将日志输出到文件。
   - `"dateFile"`：按日期将日志输出到不同的文件。
   - `"stdout"`：将日志输出到标准输出流。
   - `"stderr"`：将日志输出到标准错误流。
   - 自定义输出器类型。
2. `filename`（仅适用于某些类型）：指定日志文件的路径和名称。例如，对于类型为 `"file"` 或 `"dateFile"` 的输出器，可以使用该选项指定日志文件的位置。
3. `maxLogSize`（仅适用于某些类型）：指定日志文件的最大字节数。当日志文件大小超过该值时，会触发日志文件的切割。
4. `keepFileExt: true`：保留日志文件的扩展名。
5. `layout`：指定日志的布局器。布局器定义了如何格式化日志消息。常见的布局器类型包括 `"basic"`、`"messagePassThrough"`、`"pattern"` 等。
   * `pattern`（仅适用于某些类型）：指定日志的布局格式。可以使用模式字符串来定义日志的格式，例如 `%c` 表示日志分类器（logger）、`%d{yyyy-MM-dd hh:mm:ss}` 表示日期时间、`%p` 表示日志级别、`%m` 表示日志消息，等等。
6. 其他特定于输出器类型的配置选项：不同的输出器类型可能有特定的配置选项，用于进一步定制输出行为。例如，对于数据库输出器，可能需要配置数据库连接信息、表名等。

> 补充：
>
> 当记录日志时，布局器（layout）用于定义日志消息的格式和布局。它决定了日志事件中各个字段的排列方式，包括时间戳、日志级别、日志分类器、日志消息等。下面是一些常见的布局器：
>
> 1. `"basic"` 布局器：这是最简单的布局器，它只输出日志消息本身，没有时间戳、级别等信息。
>
> 2. `"messagePassThrough"` 布局器：这个布局器直接将日志消息传递给输出目标，不进行任何格式化。它适用于不需要额外信息的简单输出。
>
> 3. `"pattern"` 布局器：这是一个灵活的布局器，通过定义模式字符串来控制日志消息的格式。模式字符串中可以包含占位符，每个占位符代表一个字段，例如：
>    - `%d{yyyy-MM-dd hh:mm:ss}`：日期和时间。
>    - `%p`：日志级别。
>    - `%c`：日志分类器。
>    - `%m`：日志消息。
>
>    通过组合这些占位符，可以创建自定义的日志格式。
>
> 4. 自定义布局器：除了上述内置的布局器，您还可以创建自定义的布局器来满足特定的需求。自定义布局器需要实现特定的接口，并定义如何格式化日志消息。
>

#### 认识记录器

在 log4js 的配置对象中，`categories` 是一个属性，用于定义日志记录器的分类和级别配置。它是一个包含多个键值对的对象，每个键值对表示一个日志记录器的配置。

每个键表示一个日志记录器的名称，值是一个包含以下属性的对象：

- `appenders`：指定将日志消息发送到哪些输出器（`appenders`）。可以是一个字符串或字符串数组，表示要使用的输出器的名称。输出器的名称必须在 `appenders` 配置中定义。

- `level`：指定该日志记录器的日志级别。可以是字符串或字符串数组，表示要启用的日志级别。日志级别可以是 `ALL`、`TRACE`、`DEBUG`、`INFO`、`WARN`、`ERROR`、`FATAL` 或 `OFF`。

- `enableCallStack`（可选）：指定是否在日志消息中包含调用栈信息。默认为 `false`。

以下是一个示例配置，展示了如何使用 `categories` 属性配置日志记录器：
```javascript
const log4js = require('log4js');

log4js.configure({
  appenders: {
    console: { type: 'console' },
    file: { type: 'file', filename: 'app.log' }
  },
  categories: {
    default: { appenders: ['console'], level: 'info' },
    custom: { appenders: ['file'], level: 'debug' }
  }
});

const logger1 = log4js.getLogger(); // 使用 default 配置
const logger2 = log4js.getLogger('custom'); // 使用 custom 配置

logger1.info('This is an info message'); // 会被记录到控制台
logger2.debug('This is a debug message'); // 会被记录到文件
```

在上述示例中，我们定义了两个日志记录器的配置。`default` 配置将日志消息输出到控制台，并启用了 `info` 级别及以上的日志记录。`custom` 配置将日志消息输出到文件，并启用了 `debug` 级别及以上的日志记录。通过 `log4js.getLogger()` 方法获取不同的日志记录器，并根据其配置进行日志记录。

通过 `categories` 属性，您可以根据需要为不同的日志记录器设置不同的输出器和日志级别，以满足应用程序的需求。

#### 认识日志级别

在 log4js 中，日志级别按照从低到高的顺序包括以下级别：

1. **ALL**：最低级别，启用所有日志消息的记录。

2. **TRACE**：追踪级别，用于追踪程序的详细执行过程。

3. **DEBUG**：调试级别，用于开发和调试过程中的详细信息。

4. **INFO**：信息级别，提供程序运行过程中的关键信息。

5. **WARN**：警告级别，表示潜在的问题或警告。

6. **ERROR**：错误级别，表示程序遇到了错误或异常情况。

7. **FATAL**：严重错误级别，表示严重的错误或致命的异常。

8. **OFF**：最高级别，禁用所有日志消息的记录，默认为OFF。

在 log4js 的配置中，您可以根据需求设置日志级别。通常，您可以将日志级别设置为某个特定级别，从而只记录该级别及其以上级别的日志消息。例如，如果将日志级别设置为 INFO，那么只有 INFO、WARN、ERROR 和 FATAL 级别的日志消息会被记录，而 DEBUG 和 TRACE 级别的消息会被忽略。

以下是一个示例 log4js 配置，展示了如何设置日志级别：
```javascript
const log4js = require('log4js');

log4js.configure({
  appenders: {
    console: { type: 'console' },
  },
  categories: {
    default: { appenders: ['console'], level: 'info' },
  },
});

const logger = log4js.getLogger();

logger.trace('This is a trace message'); // 不会被记录
logger.debug('This is a debug message'); // 不会被记录
logger.info('This is an info message'); // 会被记录
logger.warn('This is a warn message'); // 会被记录
logger.error('This is an error message'); // 会被记录
logger.fatal('This is a fatal message'); // 会被记录
```

在上述示例中，我们将日志级别设置为 INFO，因此只有 INFO 及以上级别的日志消息会被记录到控制台。TRACE 和 DEBUG 级别的消息不会被记录。

希望这个解释对您有所帮助！如果您有任何进一步的问题，请随时提问。

## 获取 Logger 实例

`log4js.getLogger()` 是 log4js 模块中的一个方法，用于获取一个具有指定名称的 logger 对象。

### **参数：**

- `category`（可选）：指定 logger 的名称或类别。如果未提供此参数，则使用默认类别。

### **返回值：**

- 返回一个 logger 对象，用于记录日志消息。

### **示例**

```javascript
const log4js = require('log4js');

// 获取默认类别的 logger 对象
const logger = log4js.getLogger();

// 获取名为 'myLogger' 的 logger 对象
const myLogger = log4js.getLogger('myLogger');

// 记录日志消息
logger.debug('This is a debug message');
myLogger.info('This is an info message');
```

在上述示例中，我们首先通过 `require('log4js')` 引入了 log4js 模块。然后，我们使用 `log4js.getLogger()` 方法获取了两个 logger 对象：一个是默认类别的 logger 对象，另一个是名为 `'myLogger'` 的 logger 对象。

我们可以使用这些 logger 对象来记录不同级别的日志消息。在示例中，我们使用 `logger.debug()` 记录了一个 debug 级别的日志消息，使用 `myLogger.info()` 记录了一个 info 级别的日志消息。

## 记录日志

使用 Logger 实例的不同方法，您可以记录不同级别的日志。常用的方法包括 `debug()`、`info()`、`warn()`、`error()` 和 `fatal()`。以下是示例：

```javascript
logger.debug('Debug message');
logger.info('Info message');
logger.warn('Warning message');
logger.error('Error message');
logger.fatal('Fatal message');
```

您可以根据日志的严重程度选择适当的方法来记录日志。

## 关闭日志系统

`log4js.shutdown()` 是 log4js 模块提供的方法，用于优雅地关闭日志系统。

当调用 `log4js.shutdown()` 方法时，它会执行以下操作：

1. 停止接受新的日志消息：`log4js.shutdown()` 方法会停止 log4js 接受新的日志消息，确保在关闭过程中不会丢失任何日志。

2. 等待所有已经添加到队列中的日志消息被处理完毕：log4js 内部使用队列来缓存待处理的日志消息。在调用 `log4js.shutdown()` 之后，它会等待队列中的所有日志消息都被处理完毕，以确保所有的日志都被正确地记录和处理。

3. 关闭所有的输出器（appenders）：`log4js.shutdown()` 方法会关闭所有已配置的输出器（appenders），确保它们在关闭过程中完成必要的清理操作。这可能涉及关闭文件流、断开数据库连接等。

通过调用 `log4js.shutdown()` 方法，您可以确保在关闭应用程序之前，所有的日志消息都被正确地记录和处理。这可以防止日志消息的丢失或不完整。

以下是一个示例，展示了如何使用 `log4js.shutdown()`：
```javascript
const log4js = require('log4js');

// 配置 log4js

process.on("exit", () => {
  log4js.shutdown();
});

// 其他应用程序逻辑
```

在上述示例中，我们首先配置了 log4js。然后，在应用程序的适当位置（这里以`nodejs`进程关闭为例）调用了 `log4js.shutdown()` 方法。您可以在 `其他应用程序逻辑` 部分添加您的应用程序的其他代码。
