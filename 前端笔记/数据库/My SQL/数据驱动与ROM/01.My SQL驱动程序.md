# `My SQL2`

## 一、简介：

在计算机领域，驱动程序（Driver）是一种软件程序，用于控制和管理硬件设备或特定的软件程序。驱动程序充当了硬件设备和操作系统之间的桥梁，使得操作系统能够与硬件设备进行通信和协作。

数据库驱动程序（Database Driver）是一种用于连接和与数据库进行通信的软件程序或库。数据库驱动程序通常由数据库系统的开发者或第三方开发者编写，用于在应用程序和数据库之间建立通信桥梁，使得应用程序能够执行数据库操作、查询数据和更新数据等操作。

MySQL 数据库驱动程序是用于连接和操作 MySQL 数据库的软件程序。

`mysql2` 是一个基于 Node.js 的 MySQL 数据库驱动程序，用于连接和操作 MySQL 数据库。它是 `mysql` 模块的替代品，提供了更好的性能和功能，支持 Promise、异步/await 等现代 JavaScript 特性。

npm 官网：https://www.npmjs.com/package/mysql2

## 二、功能：

1. **建立数据库连接：** MySQL 数据库驱动程序可以帮助应用程序与 MySQL 数据库建立连接。通过指定数据库的主机、用户名、密码等连接信息，驱动程序可以建立与数据库的通信通道。
2. **执行数据库查询：** 数据库驱动程序可以执行各种类型的数据库查询操作，如 SELECT 查询、INSERT 插入、UPDATE 更新、DELETE 删除等。通过驱动程序提供的 API，可以向数据库发送 SQL 查询语句并获取返回结果。
3. **处理数据库事务：** 数据库驱动程序支持事务操作，可以帮助应用程序在多个数据库操作中维护一致性。通过驱动程序提供的事务方法，可以开始、提交或回滚数据库事务。
4. **连接池管理：** MySQL 数据库驱动程序通常支持连接池管理，可以创建和管理数据库连接池，以提高数据库连接的效率和性能。连接池可以重复使用已建立的数据库连接，减少连接建立的开销。
5. **处理结果集：** 数据库驱动程序可以处理数据库查询返回的结果集，将查询结果以合适的数据结构返回给应用程序。这样应用程序可以方便地处理数据库返回的数据。
6. **错误处理：** 数据库驱动程序可以帮助应用程序处理数据库操作中可能出现的错误，提供错误信息和异常处理机制，确保数据库操作的稳定性和可靠性。

## 三、创建数据库连接：

### （一）**安装 `mysql` 模块：**

```bash
npm install mysql2
```

### （二）**引入 `mysql` 模块：**

在 Node.js 文件中引入 `mysql` 模块：

1. 直接导入`My SQL2`

```javascript
const mysql = require('mysql');
```

2. 异步导入`My SQL2`

```javascript
  const mysql = require('mysql2/promise');
```

### （三）创建数据库连接：

```javascript
const connection = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'mydatabase'
  multipleStatements: true
});
```

`mysql.createConnection()` 是 Node.js 中用于创建 MySQL 数据库连接的方法。它接受一个对象作为参数，该对象包含用于配置数据库连接的属性。下面是 `createConnection()` 方法的参数及其用法的介绍：

1. host (string, optional): 数据库服务器的主机名，默认为 "localhost"。
2. port (number, optional): 数据库服务器的端口号，默认为 3306。
3. user (string, optional): 数据库用户的用户名，默认为 "root"。
4. password (string, optional): 数据库用户的密码，默认为空字符串。
5. database (string, optional): 要连接的数据库名称。
6. `multipleStatements`：一个布尔值，指定是否允许在单个查询中使用多个语句。默认为 `false`，表示禁止使用多个语句。

### （四）连接到数据库：

```javascript
connection.connect(function(err) {
  if (err) {
    console.error('Error connecting to database: ' + err.stack);
    return;
  }
  console.log('Connected to MySQL database');
});
```

### （五）执行数据库操作

```javascript
connection.query('SELECT * FROM table', function (error, results, fields) {
  if (error) throw error;
  console.log('Query results:', results);
});
```

### （六）关闭数据库连接

```javascript
connection.end(function(err) {
  if (err) {
    console.error('Error closing database connection: ' + err.stack);
    return;
  }
  console.log('Database connection closed');
});
```

## 四、执行查询语句

执行查询语句的方法有两种， `query()` 方法和 `execute()` 方法，两种语句的传参及用法大致相同，但存在以下差异。

- 如果只是执行简单的查询语句，可以使用 `query()` 方法。但如果需要执行预准备语句或者传递参数，并且希望提高性能和安全性，建议使用 `execute()` 方法。
- 在大多数情况下，推荐使用 `execute()` 方法，因为它提供了更好的性能和安全性，并且可以避免一些潜在的安全风险。

#### （一）参数

下面是 两种方法的基本语法：

```javascript
connection.query(sql, values, callback);
//or
connection.execute(sql, values, callback);
```

- `sql`：表示要执行的 SQL 查询语句的字符串。可以包含占位符（`?`）来代替参数值。
- `values`（可选）：一个数组，包含要传递给查询的参数值。参数值将按顺序替换查询语句中的占位符。
- `callback`：一个回调函数，用于处理执行查询后的结果。回调函数有两个参数：`err` 和 `results`。`err` 是一个可能的错误对象，如果查询执行期间发生错误，它将被设置为相应的错误信息。`results` 是查询的结果，它是一个包含查询结果的数组。

下面是一个示例，展示了如何使用这两种方法执行查询并处理结果：

```javascript
const sql = "SELECT * FROM your_table WHERE id = ?";
const values = [1];
//query执行查询语句
connection.query(sql, values, function (err, results) {
  if (err) {
    console.error(err);
    return;
  }
  
  console.log(results);
});
//or
//execute执行查询语句
connection.execute(sql, values, function (err, results) {
  if (err) {
    console.error(err);
    return;
  }
  
  console.log(results);
});
```

> [!IMPORTANT]
>
> **参数化查询**：
>
> 在上面的示例中，我们并定义了一个 SQL 查询语句 `SELECT * FROM your_table WHERE id = ?`，其中使用了一个占位符 `?` 来代替参数值。然后，我们定义了一个参数数组 `values`，其中包含了要传递给查询的参数值。
>
> 接下来，我们调用 `query()` 或`execute()`方法，并传递查询语句 `sql` 和参数数组 `values`。
>
> 需要注意的是，为了确保安全性和防止 SQL 注入攻击，建议使用参数化查询（Prepared Statements）来执行带有动态参数的查询语句，而不是直接将参数值拼接到查询字符串中。这样可以避免潜在的安全风险。

#### （二）返回

在 `mysql2` 中，这两种 方法返回一个包含查询结果的数组。查询结果的具体结构和内容取决于查询语句和数据库中的数据。

对于 SELECT 查询语句，查询结果是一个包含多个对象的数组，每个对象代表一行数据。每个对象的属性对应于查询结果中的列名，属性值对应于对应列的值。

以下是一个示例，展示了 `query()` 方法返回的查询结果的结构：

```javascript
[
  { column1: value1, column2: value2, ... },
  { column1: value3, column2: value4, ... },
  ...
]
```

其中，`column1`、`column2` 等是查询结果中的列名，`value1`、`value2` 等是对应列的值。

对于 INSERT、UPDATE 和 DELETE 等操作，`query()` 方法返回一个对象，其中包含有关受影响行数等操作信息。

下面是 INSERT 查询语句的返回结果示例：

```c++
ResultSetHeader {
  fieldCount: 0,
  affectedRows: 1,
  insertId: 4,
  info: '',
  serverStatus: 2,
  warningStatus: 0
}
```

> [!NOTE]
>
> 这段代码展示了一个名为 `ResultSetHeader` 的对象，它包含了一些关于执行查询操作后的结果信息：
>
> - `fieldCount`：字段数量，表示查询结果中的列数。在这个例子中，值为 0，表示查询结果中没有列。
>
> - `affectedRows`：受影响的行数，表示执行查询操作后影响的数据库行数。在这个例子中，值为 1，表示有一行数据受到了影响。
>
> - `insertId`：插入的 ID，表示执行插入操作后生成的自增 ID 值。在这个例子中，值为 4，表示插入操作生成的自增 ID 是 4。
>
> - `info`：信息，表示关于查询操作的一些额外信息。在这个例子中，值为空字符串，表示没有额外的信息。
>
> - `serverStatus`：服务器状态，表示服务器的状态代码。在这个例子中，值为 2，具体的含义可能需要参考 MySQL 的文档或相关资料来了解。
>
> - `warningStatus`：警告状态，表示警告的状态代码。在这个例子中，值为 0，表示没有警告。

## 五、创建连接池

相比较创建数据库连接，在生产环境下的数据请求更多，单个数据库连接不能处理这个问题，可以通过创建连接池来解决。

在 `mysql2` 中，`createPool()` 方法用于创建连接池，以便在与 MySQL 数据库的交互中更高效地管理连接。连接池可以提供连接的复用和管理，以减少每次与数据库建立连接的开销。以下是 `createPool()` 方法的参数和用法：

- `config`（必需）：一个对象，包含连接池的配置信息。可以包含以下属性：
  - `host`：MySQL 服务器的主机名，默认为 `'localhost'`。
  - `port`：MySQL 服务器的端口号，默认为 `3306`。
  - `user`：连接数据库所使用的用户名，默认为 `'root'`。
  - `password`：连接数据库所使用的密码，默认为空字符串。
  - `database`：要连接的数据库名称，默认为空字符串。
  - `waitForConnections`：一个布尔值，指定当连接池达到最大连接数时，是否等待可用连接。默认为 `true`。
  - `connectionLimit`：连接池中允许的最大连接数，默认为 `10`。
  - `queueLimit`：当连接池已满时，允许排队的最大请求数，默认为 `0`，表示不限制排队请求数。

- 返回值：一个连接池对象，可以用于执行查询和管理连接。

以下是一个示例，演示了如何使用 `createPool()` 方法创建连接池并执行查询：

```javascript
const mysql = require('mysql2');

const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'mydatabase',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

// 从连接池获取连接
pool.getConnection((err, connection) => {
  if (err) {
    console.error(err);
    return;
  }

  // 执行查询
  connection.query('SELECT * FROM users', (err, results) => {
    connection.release(); // 释放连接到连接池

    if (err) {
      console.error(err);
      return;
    }

    console.log(results);
  });
});

// 关闭连接池
pool.end();
```

在上面的示例中，我们使用 `createPool()` 方法创建了一个连接池，其中包含了连接所需的配置信息。然后，我们通过 `getConnection()` 方法从连接池中获取一个连接，并在回调函数中执行查询操作。查询完成后，我们使用 `connection.release()` 方法将连接释放回连接池。最后，我们调用 `pool.end()` 方法来关闭连接池。

使用连接池的好处是，可以有效地管理连接，避免每次查询都创建和销毁连接的开销，提高了数据库交互的效率。

## 六、Promise 封装

MySQL2 也支持 Promise API。 

```javascript
async function main() {
  // get the client
  const mysql = require('mysql2/promise');
  // create the connection
  const connection = await mysql.createConnection({host:'localhost', user: 'root', database: 'test'});
  // query database
  const [rows, fields] = await connection.execute('SELECT * FROM `table` WHERE `name` = ? AND `age` > ?', ['Morty', 14]);
}
```

在进行Promise 封装后，`execute()`不用再传入回调函数做参数，会返回一个数组，如果要获取查询结果可以通过解构的方法来得到。

```javascript
  const [result] = await connection.execute(
    "SELECT * FROM company WHERE id = 1;"
  );
```

## 七、创建数据库模板

- [ ] 查询公司表的数据，复习查询语句，增加语句，删除语句


