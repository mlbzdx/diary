## 三层架构

![image-20231103145552261](https://mlbzdx.oss-cn-chengdu.aliyuncs.com/image-20231103145552261.png)

## 模型实例

### 创建和保存模型实例

在 ORM（对象关系映射）中，`build()` 和 `save()` 是常用的方法，用于创建和保存模型实例到数据库中。

1. `build()` 方法(同步方法)用于创建一个模型实例，但并不保存到数据库中。它接受一个对象作为参数，该对象包含要创建的实例的属性和值。示例代码如下：

   ```javascript
   const user = User.build({
     name: 'John',
     email: 'john@example.com'
   });
   ```

   在上述示例中，`User.build()` 创建了一个名为 `user` 的 `User` 模型实例，该实例具有指定的属性值。

2. `save()` 方法用于将模型实例保存到数据库中。它可以在调用 `build()` 方法后使用，也可以直接在模型实例上调用。示例代码如下：

   ```javascript
   const user = User.build({
     name: 'John',
     email: 'john@example.com'
   });
   
   user.save().then(() => {
     console.log('User saved to the database');
   }).catch((error) => {
     console.error('Error saving user:', error);
   });
   ```

   在上述示例中，`user.save()` 将 `user` 实例保存到数据库中。`save()` 方法返回一个 Promise，可以使用 `then()` 和 `catch()` 方法处理保存成功或失败的情况。

   另外，也可以直接在模型实例上调用 `save()` 方法，而无需先调用 `build()` 方法：

   ```javascript
   const user = new User({
     name: 'John',
     email: 'john@example.com'
   });
   
   user.save().then(() => {
     console.log('User saved to the database');
   }).catch((error) => {
     console.error('Error saving user:', error);
   });
   ```

   在这个示例中，`new User()` 创建了一个 `User` 模型实例，并直接在该实例上调用了 `save()` 方法。

3. 在 ORM（对象关系映射）中，`create()` 方法是用于创建并保存模型实例到数据库中的常用方法。它是 `build()` 和 `save()` 方法的组合使用，可以更简洁地实现创建和保存操作。

   `create()` 方法可以在模型上直接调用，它接受一个对象作为参数，该对象包含要创建的实例的属性和值。示例代码如下：

   ```javascript
   User.create({
     name: 'John',
     email: 'john@example.com'
   }).then((user) => {
     console.log('User created:', user);
   }).catch((error) => {
     console.error('Error creating user:', error);
   });
   ```

   在上述示例中，`User.create()` 创建了一个名为 `User` 的模型实例，并将其保存到数据库中。`create()` 方法返回一个 Promise，可以使用 `then()` 和 `catch()` 方法处理创建成功或失败的情况。在 `then()` 方法中，可以获取到保存成功后的模型实例。

   `create()` 方法的优点是它将创建和保存操作合并在一起，简化了代码的编写。它是一种常用的方式来快速创建和保存模型实例到数据库中。

### 批量创建模型实例

`bulkCreate()` 方法是 Sequelize 中用于批量创建模型实例的方法。它接受一个包含要创建实例的数据对象数组的参数，并将这些数据插入到数据库中对应的表中。下面是关于 `bulkCreate()` 方法的一些重要信息：

语法：
```javascript
Model.bulkCreate(records, options)
```

参数：
- `records`：一个包含要创建实例的数据对象数组。每个数据对象表示一个要创建的实例。
- `options`（可选）：一个包含可选配置选项的对象。

返回值：
- 返回一个 Promise，解析为一个包含已创建实例的数组。

使用示例：
```javascript
const { Class } = require("./models");

const classesData = [
  { className: "Math" },
  { className: "Science" },
  { className: "History" },
];

Class.bulkCreate(classesData)
  .then((createdClasses) => {
    console.log("Classes created:", createdClasses);
  })
  .catch((error) => {
    console.error("Error creating classes:", error);
  });
```

在上述示例中，我们导入了 `Class` 模型类，并创建了一个包含要创建班级的数据对象数组 `classesData`。然后，我们调用 `Class.bulkCreate()` 方法并传递 `classesData` 数组作为参数来批量创建班级实例。

通过 Promise 的解析值，我们可以获取一个包含已创建实例的数组 `createdClasses`。在示例中，我们简单地将其打印到控制台。

`bulkCreate()` 方法还支持一些可选的配置选项，可以在 `options` 参数中传递。例如，可以设置 `validate: true` 来进行数据验证，或者设置 `ignoreDuplicates: true` 来忽略重复的数据。

需要注意的是，`bulkCreate()` 方法会直接将数据插入到数据库中，而不会触发模型的生命周期钩子或验证器。因此，在使用 `bulkCreate()` 方法之前，请确保数据已经经过验证和处理。

总结：`bulkCreate()` 方法允许批量创建模型实例，并返回一个 Promise，解析为已创建实例的数组。

### 删除实例

`destroy()` 是 `Sequelize` 中用于从数据库中删除模型实例对应记录的方法。它可以在模型实例上调用，或者在模型类上使用静态方法调用。

使用 `destroy()` 方法会执行一条删除语句，将数据库中与模型实例对应的记录删除。它接受一个可选的配置对象作为参数，用于指定删除操作的条件和选项。

以下是一个示例代码，演示了如何使用 `destroy()` 方法删除一个名为 `User` 的模型实例：

```javascript
const user = await User.findByPk(1);
if (user) {
  await user.destroy();
  console.log('User deleted successfully');
} else {
  console.log('User not found');
}
```

在上述示例中，首先使用 `findByPk()` 方法查找主键值为 1 的 `User` 记录。如果找到了对应的模型实例，则可以在 `then()` 方法中调用 `destroy()` 方法来删除该实例对应的数据库记录。如果未找到匹配的记录，则不执行删除操作。

除了在模型实例上调用 `destroy()` 方法外，还可以在模型类上使用静态方法进行删除操作。以下是一个示例代码：

```javascript
await User.destroy({
  where: {
    id: 1
  }
});
console.log('User deleted successfully');
```

在上述示例中，使用 `User.destroy()` 方法删除具有 `id` 值为 1 的 `User` 记录。可以通过 `where` 属性指定删除操作的条件。

### 更新实例

如果你更改实例的某个字段的值,则再次调用 `save` 将相应地对其进行更新：

```javascript
const jane = await User.create({ name: "Jane" });
console.log(jane.name); // "Jane"
jane.name = "Ada";
// 数据库中的名称仍然是 "Jane"
await jane.save();
// 现在该名称已在数据库中更新为 "Ada"！
```



您可以使用 [`set`](https://sequelize.org/api/v6/class/src/model.js~Model.html#instance-method-set) 方法一次更新多个字段:

```javascript
const jane = await User.create({ name: "Jane" });

jane.set({
  name: "Ada",
  favoriteColor: "blue"
});
// 如上, 数据库中还是 "Jane" 和 "green"
await jane.save();
// 数据库现在将 "Ada" 和 "blue" 作为 name 和 favoriteColor
```

请注意, 此处的 `save()` 也将保留在此实例上所做的任何其他更改, 而不仅仅是之前的 `set` 调用中的更改.如果要更新一组特定的字段, 可以使用[`update`](https://sequelize.org/api/v6/class/src/model.js~Model.html#instance-method-update):

```javascript
const jane = await User.create({ name: "Jane" });
jane.favoriteColor = "blue"
await jane.update({ name: "Ada" })
// 数据库现在将 "Ada" 作为 name，但仍然有默认的 "green" 作为 favoriteColor
await jane.save()
// 数据库现在将 "Ada" 作为 name，但仍然有默认的 "blue" 作为 favoriteColor
```

`update()` 方法可以在模型类上调用，接受两个参数：要更新的属性和更新的条件。

下面是一个示例代码，演示了如何使用 `update()` 方法更新一个名为 `User` 的模型实例：

```javascript
const [numAffectedRows, affectedRows] = await User.update(
  { firstName: 'John', lastName: 'Doe' },
  { where: { id: 1 } }
);
console.log('User updated successfully');
```

在上述示例中，使用 `update()` 方法将具有 `id` 值为 1 的 `User` 记录的 `firstName` 和 `lastName` 属性更新为新的值。`where` 属性指定了更新操作的条件。

### 其他实例方法

模型实例通常具有一些常用的方法，用于在数据库中执行各种操作。以下是一些常见的模型实例方法：

1. `save()`: 将模型实例保存到数据库中。如果实例已经存在于数据库中，则更新对应的记录。

2. `update()`: 更新模型实例在数据库中的记录。可以传入一个对象，指定要更新的属性和值。

3. `destroy()`: 从数据库中删除模型实例对应的记录。

4. `reload()`: 重新从数据库中加载模型实例的属性值，以确保实例的属性值是最新的。

5. `get()`: 获取模型实例的指定属性的值。

6. `set()`: 设置模型实例的指定属性的值。

7. `validate()`: 对模型实例进行验证，检查属性值是否符合定义的验证规则。

8. `increment()`: 增加模型实例的指定属性的值。

9. `decrement()`: 减少模型实例的指定属性的值。

10. `toJSON()`: 将模型实例转换为 JSON 格式的对象。

这些方法可以根据具体的 ORM 库和模型定义而有所不同。此外，还可以通过定义模型的关联关系来使用其他高级方法，例如获取关联模型的数据、进行联合查询等。这些方法的具体实现和用法也会因 ORM 库的不同而有所差异。
