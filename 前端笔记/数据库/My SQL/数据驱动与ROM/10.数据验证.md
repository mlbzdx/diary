# 第三方库： `validate.js`

> 官网：https://validatejs.org/#validate-js

## 简介

`validate.js` 是一个用于前端和后端的轻量级验证库，用于验证表单输入、对象属性等数据的有效性。

`validate.js` 提供了各种验证规则和函数，可以用于定义验证规则、验证数据并获取验证结果。它支持各种验证类型，包括必填字段、字符串长度、电子邮件格式、数字范围等等。你可以根据具体的需求自定义验证规则。

以下是一个示例，演示如何使用 `validate.js` 进行数据验证：

## 安装

1. 浏览器/`cdn`导入

   ```html
   <script src="//cdnjs.cloudflare.com/ajax/libs/validate.js/0.13.1/validate.min.js"></script>
   ```

   

2. `npm/node.js`安装

   ```bash
   npm install validate.js  --save
   ```



## 学习目标：

学习 `validate.js` 时，以下是一些主要的知识点需要掌握：

1. 验证规则和选项：了解 `validate.js` 提供的各种验证规则和选项。这些规则包括必填字段、字符串长度、电子邮件格式、数字范围等等。你需要了解每个验证规则的语法、参数和用法。

2. 验证函数：`validate.js` 提供了一些内置的验证函数，用于执行常见的验证任务。这些函数包括 `presence`、`length`、`numericality`、`email` 等。你需要了解这些函数的作用和用法，并知道如何将它们应用到你的验证规则中。

3. 自定义验证规则：`validate.js` 允许你定义自己的验证规则。你可以编写自定义的验证函数，并将其添加到验证规则中。你需要了解如何编写验证函数、传递参数以及在验证规则中使用自定义函数。

4. 数据验证：学会如何使用 `validate.js` 对数据进行验证。了解如何构造要验证的数据对象，并调用相应的验证函数进行验证。你需要知道如何处理验证结果以及如何处理验证失败的情况。

5. 错误处理和消息定制：当验证失败时，`validate.js` 提供了错误消息的处理和定制功能。你需要了解如何获取验证失败的详细信息，并根据需要自定义错误消息的格式和内容。

6. 集成到项目中：学会将 `validate.js` 集成到你的项目中。根据你的项目框架和架构，了解如何在前端或后端代码中使用 `validate.js` 进行数据验证。

7. 调试和错误排查：当遇到验证问题或错误时，学会使用调试工具和技术来排查问题。了解如何使用日志记录、错误处理和调试工具来定位和解决验证问题。

8. 最佳实践和性能优化：了解 `validate.js` 的最佳实践和性能优化技巧。学会如何编写高效的验证规则和函数，以及如何优化验证流程，提高验证的性能和效率。

通过掌握这些知识点，你将能够有效地使用 `validate.js` 进行数据验证，并在你的项目中实现有效的输入验证和数据有效性检查。

## 验证规则和选项

> ### 1.认识验证规则

验证规则，又称为验证约束，即constraints 。验证约束有以下的格式

```c++
{
  <attribute>: {
    <validator name>: <validator options>
  }
}                                                                                                                                                                                                                                                                                
```

* ` <attribute>`，需要验证属性对象中的属性
* `<validator name>: <validator options>`，验证规则的名称及其可配置的选项

> ### 2.验证规则的类型

验证规则主要包括下面几种类型：

在 `validate.js` 中，验证规则用于定义对数据进行验证的条件，而验证选项则提供了一些额外的配置参数。以下是一些常见的验证规则和选项的相关知识和用例：

1. 必填字段（`presence`）规则：
   - 知识点：`presence` 规则用于验证字段是否必须存在且非空。
   - 用例：验证用户注册表单中的必填字段，如用户名、密码等。
2. 字符串长度（`length`）规则：
   - 知识点：`length` 规则用于验证字符串的长度是否在指定的范围内。
   - 选项：可以指定最小长度、最大长度和精确长度等选项。
   - 用例：验证文本框中输入的用户名是否在指定的长度范围内。
3. 数字范围（`numericality`）规则：
   - 知识点：`numericality` 规则用于验证数字字段是否在指定的范围内。
   - 选项：可以指定最小值、最大值和整数要求等选项。
   - 用例：验证年龄字段是否在有效的年龄范围内。
4. 电子邮件格式（`email`）规则：
   - 知识点：`email` 规则用于验证电子邮件字段是否符合有效的电子邮件格式。
   - 用例：验证用户输入的电子邮件地址是否符合有效的格式要求。
5. 正则表达式（`format`）规则：
   - 知识点：`format` 规则用于基于正则表达式验证字段的格式。
   - 选项：可以指定一个正则表达式模式来进行验证。
   - 用例：验证电话号码字段是否符合指定的电话号码格式。
7. 日期（`date`）规则：
   - 知识点：`date` 规则用于验证日期字段的有效性。
   - 用例：验证用户输入的日期是否符合指定的日期格式和范围要求。
8. 日期时间（`datetime`）规则：
   - 知识点：`datetime` 规则用于验证日期时间字段的有效性。
   - 用例：验证用户输入的日期时间是否符合指定的日期时间格式和范围要求。
9. 相等性（`equality`）规则：
   - 知识点：`equality` 规则用于验证字段的值是否与指定的值相等。
   - 用例：验证密码确认字段是否与密码字段的值相等。
10. 排除值（`exclusion`）规则：
   - 知识点：`exclusion` 规则用于验证字段的值是否排除在指定的值列表之外。
   - 用例：验证用户选择的选项是否在排除列表之外
11. 包含值（`inclusion`）规则：
    - 知识点：`inclusion` 规则用于验证字段的值是否包含在指定的值列表中。
    - 用例：验证用户选择的选项是否在允许的值列表中。
12. 数据类型（`type`）规则：
    - 知识点：`type` 规则用于验证字段的数据类型是否符合指定的类型。
    - 用例：验证字段的数据类型，如字符串、数字、布尔值等。
13. URL（`url`）规则：
    - 知识点：`url` 规则用于验证 URL 字段的有效性。
    - 用例：验证用户输入的 URL 是否符合有效的 URL 格式要求。
14. 自定义验证规则：
    - 知识点：`validate.js` 允许你定义自己的验证规则，以满足特定的验证需求。
    - 用例：自定义验证规则来验证密码复杂性，例如包含大写字母、小写字母、数字和特殊字符。



验证函数

 `validate(attributes, constraints, [options])` 

验证函数的作用是根据属性来验证属性对象。验证函数包含三个参数

* 第一个参数是验证的属性对象 `attributes`
* 第二个参数是约束规则 `constraints`
* 第三个是可选参数 `options`

验证函数的返回结果：

如果没有错误，那么不返回任何内容

如果有错误，那么返回以下格式的对象： `{<attribute>: [<error>, <error>, ...]}`

 

## 规则：`presence`

`presence`用来验证是否定义了值,是最常用的验证器.

`presence`可以直接设置为布尔值

```javascript
presence : true
```

也可以设置为一个配置对象

```javascript
presence : {
	message : "xxx不能为空",
	allowEmpty:false
}
```

通过设置 `validate.validators.presence.message` 来更改返回的默认消息，默认返回的消息是 `xxx  can't be blank`，如上例，修改后返回的是 `xxx不能为空`。

通过设置 `validate.validators.presence.allowEmpty`为 `false`可以扩充没有定义值的情况范围。

当出现以下定义时，会默认为没有定义值：

* `null`
* `undefined`

其他的值被视为有效定义。

设置 `allowEmpty`后，下面的情况也会被视为没有定义值：

* `{}` (空对象)
* `""`（空字符串）以及 `" "` （内容仅空格的字符串）

其他的值被视为有效定义。

## 规则：`type`

`type`确保输入的类型正确

内置的类型有：

- `array`
- `integer`
- `number`
- `string`
- `date`
- `boolean`

你也可以设置`validate.validator.type.types`来自定义类型。

```javascript
validate.validators.type.types.customType = function (value) { return value === "stuff"; };
validate({myAttribute: true}, {myAttribute: {type: "customType"}});
// => {"myAttribute": ["My attribute must be of type customType"]}
```

通过设置 `validate.validators.type.messages`来设置自定义类型返回的消息

```javascript
validate.validators.type.messages.customType = "is simply wrong";
validate({myAttribute: true}, {myAttribute: {type: "customType"}});
// => {"myAttribute": ["My attribute is simply wrong"]}
```

##  规则：length

该规则用来验证字符串的长度（任何具有该 `length` 属性的对象都可以进行验证，但所有默认错误消息都引用字符串，因此，如果您计划使用它来验证数组，请确保覆盖它们。）

可以设置下面几个属性来指定长度约束：

```javascript
length:{
	is : 3
}
//长度必须为3
length:{
	minimum : 3
}
//长度至少为3
length:{
	maximum:5
}
//长度最多为5
```

默认返回的消息

```
incorrect length   //长度不正确
is the wrong length (should be %{count} characters)  //错误的长度，应该是 %{count} 个字符
is too short (minimum is %{count} characters)  //字符串太短 至少为 %{count} 个字符
 is too long (maximum is %{count} characters) //字符串太长 最多为 %{count} 个字符
```

修改返回的默认消息，可以通过设置以下属性来 `validate.validators.length` 更改默认消息：

- `notValid`
- `tooLong`
- `tooShort`
- `wrongLength`

## 规则：`datatime`

该规则可用于验证日期和时间

可以通过设置下面几个属性来对日期和时间作出约束

```javascript
datetime:{
	dateOnly : true
}
//如果为 true，则只允许日期（而不是日期时间）。默认错误必须是有效日期
datetime:{
	earliest: moment.utc().subtract(18, 'years')
}
//日期不能早于此时间。此参数将使用函数 parse 进行解析，就像值一样。默认错误不得早于 %{date}
datetime:{
	latest: moment.utc().subtract(18, 'years')
}
//日期不能在此时间之后。此参数将使用函数 parse 进行解析，就像值一样。默认错误不得晚于 %{date}
```

您可以通过在 `validate.validators.datetime` 对象或验证程序的选项上设置以下任一设置来更改消息：

- `notValid`
- `tooEarly`
- `tooLate`

定义好 `datatime`规则后不能直接使用，还需要定义扩展函数（`validate.extend`）。在 `validate.js`中没有采用 `javascript`的日期解析方式，支持开发者自己定义转换解析函数，推荐开发者使用第三方库 `moment`来实现日期的解析与转换。

首先，`validate.js`在扩展函数中定义了两个函数 `parse `和 `format`，这两个函数会在验证前被调用，开发者需要在这两个函数中定义日期和时间的解析方式与返回值。

两个函数默认接收同样的两个参数：`value`，`options`。

`vulue`是时间，在 `parse`函数中 `vulue` 是传入的不同格式的时间，在 `format`函数中是经parse函数转化后的`unix` 时间戳。

`options`为开发者已经定义好的 `datetime`规则(约束)。在 parse函数解析的过程中，规则中的 `earliest` 和 `latest` 也会和 `value`被解析为`unix` 时间戳来进行比较。

两个函数的返回值：

parse函数需要将传入的不同格式的时间最终解析为`unix` 时间戳并返回。

format函数需要将parse函数返回的时间戳转化为用户友好的时间格式并返回。

```javascript
const moment = require(moment);
const validate = require("validate.js");
validate.extend(validate.validators.datetime, {
  parse(value, options) {
    let formats = ["YYYY-MM-DD HH:mm:ss", "YYYY-M-D H:m:s", "x"];
    if (options.dateOnly) {
      formats = ["YYYY-MM-DD", "YYYY-M-D", "x"];
    }
    return +moment.utc(value, formats, true);
  },
  format(value, options) {
    let formats = "YYYY-MM-DD";
    if (!options.dateOnly) {
      formats += "HH:mm:ss";
    }
    return moment.utc(value).format(formats);
  },
});

```

## 自定义验证规则

通过给 `validate.validate`添加方法来自定义验证规则。

