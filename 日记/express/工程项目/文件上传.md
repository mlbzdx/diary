上传图片需要使用到第三方库：multer

> 中文文档：https://github.com/expressjs/multer/blob/main/doc/README-zh-cn.md

安装第三方库：

```bash
$ npm install --save multernpm install --save multer
```

第一步：编写上传路由中间件，在入口文件注册该中间件

> ./routes/uploadRouter

```js
var express = require("express");
var router = express.Router();
router.post("/", async (req, res, next) => {
 
});
module.exports = router; 
```

> ./app.js

```js
var uploadRouter = require("./routes/uploadRouter");
//...
app.use("/api/upload", uploadRouter);
```

第二步：编写上传文件工具函数 

> /utils/tool.js

```js
// 设置上传文件的引擎
const storage = multer.diskStorage({
    // 文件存储的位置
    destination: function (req, file, cb) {
        cb(null, __dirname + '/../public/static/uploads');
    },
    // 上传到服务器的文件，文件名要做单独处理
    filename: function (req, file, cb) {
        // 获取文件名
        const basename = path.basename(file.originalname, path.extname(file.originalname));
        // 获取后缀名
        const extname = path.extname(file.originalname);
        // 构建新的名字
        const newName = basename + new Date().getTime() + Math.floor(Math.random() * 9000 + 1000) + extname;
        cb(null, newName);
    }
})

module.exports.uploading = multer({
    storage: storage,
    limits: {
        fileSize: 2000000,
        files: 1
    }
})
```

---

第三步：完善上传路由逻辑，自定义上传错误处理机制

> 上传图片的接口文档：
>
> 请求路径：/api/upload
>
> 请求方法：POST
>
> 请求配置：
>
> | header参数    | 示例值               |
> | ------------- | -------------------- |
> | Content-Type  | multipart/form-data  |
> | Authorization | Bearer + 空格 +token |
>
> 
>
> | body参数 | 格式：multipart/form-data |
> | -------- | ------------------------- |
> | file     | 要上传的文件，必须是图片  |
>
> 返回响应：
>
> HTTP 状态码: 200
>
> 内容格式: JSONapplication/json
>
> 数据结构：
>
> ```json
> {
>     "code": 0,
>     "msg": "string",
>     "data": "string"
> }
> ```

```js
var express = require("express");
const multer = require("multer");
const { UploadError } = require("../utils/errors");
const { uploading, formatResponse } = require("../utils/tool");
var router = express.Router();

// 获取首页标语
router.post("/", async function (req, res, next) {
    // single 方法里面书写上传控件的 name 值
    uploading.single("file")(req, res, function (err) {
        if(err instanceof multer.MulterError){
            next(new UploadError("上传文件失败，请检查文件的大小，控制在 2MB 以内"));
        } else {
            const path = "/static/uploads/" + req.file.filename;
            res.send(formatResponse(0, "", path));
        }
    })
});

module.exports = router;
```

> ## 错误处理机制
>
> 
>
> 当遇到一个错误，multer 将会把错误发送给 express。你可以使用一个比较好的错误展示页 ([express标准方式](http://expressjs.com/guide/error-handling.html))。
>
> 如果你想捕捉 multer 发出的错误，你可以自己调用中间件程序。如果你想捕捉 [Multer 错误](https://github.com/expressjs/multer/blob/main/lib/multer-error.js)，你可以使用 `multer` 对象下的 `MulterError` 类 (即 `err instanceof multer.MulterError`)。
>
> ```
> const multer = require('multer')
> const upload = multer().single('avatar')
> 
> app.post('/profile', function (req, res) {
>   upload(req, res, function (err) {
>     if (err instanceof multer.MulterError) {
>       // 发生错误
>     } else if (err) {
>       // 发生错误
>     }
> 
>     // 一切都好
>   })
> })
> ```
