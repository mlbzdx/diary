# Sequelize 数据模型关联详解

在 Sequelize（Node.js 的 ORM 库）中，模型关联（Associations）是定义数据模型（表）之间关系的核心功能。它通过面向对象的方式，抽象了数据库中的关系，简化了复杂的关系操作。

---

## 一、关联的四种基本类型

### 1. 一对一 (One-to-One)
- **描述**：一个模型的一个实例关联到另一个模型的一个实例。
- **实现方式**：
  ```javascript
  // 在 Profile 表中添加 userId 外键
  User.hasOne(Profile);
  Profile.belongsTo(User);
  ```
- **数据库表现**：
  ```sql
  CREATE TABLE Users (id INT PRIMARY KEY);
  CREATE TABLE Profiles (
    id INT PRIMARY KEY,
    userId INT UNIQUE REFERENCES Users(id)
  );
  ```
- **应用场景**：用户与用户资料、公司与营业执照。

---

### 2. 一对多 (One-to-Many)
- **描述**：一个模型的一个实例关联到另一个模型的多个实例。
- **实现方式**：
  ```javascript
  // 在 Articles 表中添加 authorId 外键
  User.hasMany(Article);
  Article.belongsTo(User);
  ```
- **数据库表现**：
  ```sql
  CREATE TABLE Users (id INT PRIMARY KEY);
  CREATE TABLE Articles (
    id INT PRIMARY KEY,
    authorId INT REFERENCES Users(id)
  );
  ```
- **应用场景**：用户与文章、部门与员工。

---

### 3. 多对多 (Many-to-Many)
- **描述**：一个模型的多个实例关联到另一个模型的多个实例。
- **实现方式**：
  ```javascript
  // 自动创建 ArticleTag 连接表
  Article.belongsToMany(Tag, { through: 'ArticleTag' });
  Tag.belongsToMany(Article, { through: 'ArticleTag' });
  ```
- **数据库表现**：
  ```sql
  CREATE TABLE Articles (id INT PRIMARY KEY);
  CREATE TABLE Tags (id INT PRIMARY KEY);
  CREATE TABLE ArticleTag (
    articleId INT REFERENCES Articles(id),
    tagId INT REFERENCES Tags(id),
    PRIMARY KEY (articleId, tagId)
  );
  ```
- **应用场景**：文章与标签、学生与课程。

---

### 4. 超级多对多 (Super Many-to-Many)
- **描述**：多对多关系的扩展，允许在连接表中存储额外属性。
- **实现方式**：
  ```javascript
  // 定义连接模型
  const Enrollment = sequelize.define('Enrollment', {
    grade: DataTypes.STRING
  });
  
  Student.belongsToMany(Course, { through: Enrollment });
  Course.belongsToMany(Student, { through: Enrollment });
  ```
- **应用场景**：学生选课（带成绩）、用户产品收藏（带收藏时间）。

---

## 二、关联方法详解

### 核心方法
| 方法              | 描述           | 外键位置     |
| ----------------- | -------------- | ------------ |
| `hasOne()`        | 建立一对一关系 | **目标模型** |
| `belongsTo()`     | 建立从属关系   | **源模型**   |
| `hasMany()`       | 建立一对多关系 | **目标模型** |
| `belongsToMany()` | 建立多对多关系 | **连接表**   |

### 配置选项
```javascript
Model.hasMany(TargetModel, {
  foreignKey: 'custom_fk',   // 自定义外键名
  sourceKey: 'id',           // 源模型关联键（默认主键）
  as: 'aliasName',           // 查询时使用的别名
  onDelete: 'CASCADE',       // 级联删除
  onUpdate: 'CASCADE',       // 级联更新
  constraints: true,         // 是否创建数据库约束
  hooks: true                // 是否触发钩子
});
```

---

## 三、关联查询实践

### 1. 基本包含查询
```javascript
// 查询用户及其所有文章
const userWithArticles = await User.findByPk(1, {
  include: Article
});

// 使用别名
const user = await User.findByPk(1, {
  include: {
    model: Article,
    as: 'posts'
  }
});
```

---

### 2. 嵌套包含查询
```javascript
// 查询文章及其作者和标签
const article = await Article.findByPk(1, {
  include: [
    { model: User, as: 'author' },
    { model: Tag, through: { attributes: [] } } // 排除连接表属性
  ]
});
```

---

### 3. 条件过滤
```javascript
// 查询包含特定标签的文章
const articles = await Article.findAll({
  include: {
    model: Tag,
    where: { name: 'JavaScript' }
  }
});
```

---

### 4. 分页与排序
```javascript
// 分页查询用户及其文章
const users = await User.findAll({
  include: {
    model: Article,
    limit: 5,
    order: [['createdAt', 'DESC']]
  },
  offset: 10,
  limit: 5
});
```

---

## 四、关联操作

### 1. 创建关联数据
```javascript
// 创建用户并关联文章
const user = await User.create({
  name: 'Alice',
  articles: [
    { title: 'Sequelize Guide' },
    { title: 'Node.js Best Practices' }
  ]
}, {
  include: [Article] // 包含关联模型
});
```

---

### 2. 添加关联
```javascript
// 为用户添加新文章
const user = await User.findByPk(1);
const newArticle = await Article.create({ title: 'New Post' });
await user.addArticle(newArticle);

// 批量添加标签
const article = await Article.findByPk(1);
await article.addTags([tag1, tag2, tag3]);
```

---

### 3. 移除关联
```javascript
// 移除单个关联
await user.removeArticle(article);

// 移除所有关联
await article.setTags([]);
```

---

## 五、高级关联模式

### 1. 多态关联
```javascript
// 评论可关联文章或产品
Comment.belongsTo(Commentable, {
  polymorphic: true,
  scope: {
    commentableType: ['article', 'product']
  }
});

// 使用
const comment = await Comment.create({
  content: 'Great post!',
  commentableId: 1,
  commentableType: 'article'
});
```

---

### 2. 层级结构（自关联）
```javascript
// 员工-经理层级
Employee.hasMany(Employee, {
  as: 'Subordinates',
  foreignKey: 'managerId'
});
Employee.belongsTo(Employee, {
  as: 'Manager',
  foreignKey: 'managerId'
});
```

---

### 3. 复合主键关联
```javascript
// 使用复合主键
User.hasMany(Order, {
  foreignKey: {
    name: 'userId',
    allowNull: false
  },
  sourceKey: ['tenantId', 'id'] // 复合主键
});
```

---

## 六、性能优化技巧

1. **选择必要字段**：
   ```javascript
   include: {
     model: Article,
     attributes: ['id', 'title'] // 仅选择需要的字段
   }
   ```

2. **分离查询**：
   ```javascript
   // 避免复杂 JOIN
   const user = await User.findByPk(1);
   const articles = await user.getArticles();
   ```

3. **批量预加载**：
   ```javascript
   const users = await User.findAll();
   const articles = await Article.findAll({
     where: { userId: users.map(u => u.id) }
   });
   ```

4. **使用原生查询**：
   ```javascript
   const [results] = await sequelize.query(`
     SELECT u.name, COUNT(a.id) AS article_count
     FROM Users u
     LEFT JOIN Articles a ON a.userId = u.id
     GROUP BY u.id
   `);
   ```

---

## 七、常见问题解决方案

### 1. 循环依赖
```javascript
// models/index.js
const User = require('./user');
const Article = require('./article');

// 延迟定义关联
module.exports = (sequelize) => {
  User.associate = ({ Article }) => {
    User.hasMany(Article);
  };

  Article.associate = ({ User }) => {
    Article.belongsTo(User);
  };
};
```

---

### 2. 别名冲突
```javascript
// 为同一模型的不同关联设置别名
Project.hasMany(Task, { as: 'TodoTasks' });
Project.hasMany(Task, { as: 'CompletedTasks' });
```

---

### 3. 软删除关联
```javascript
// 使用 paranoid 和作用域
User.hasMany(Article, {
  as: 'ActiveArticles',
  scope: {
    deletedAt: null
  }
});
```

---

## 总结

Sequelize 提供了强大的模型关联功能：
- 支持多种关系类型（1:1, 1:N, N:M）。
- 提供简洁的 API 操作关联。
- 支持复杂查询与嵌套加载。
- 包含高级模式（多态、自关联等）。

在实际项目中：
1. 在模型定义中统一管理关联。
2. 使用别名提高代码可读性。
3. 为生产环境添加适当索引。
4. 对复杂关联进行性能测试。

合理使用关联可以大幅提升开发效率，同时保持数据一致性，为应用构建坚实的数据层基础。