### 问题分析：`alter: true` 的使用

```javascript
await sequelize.sync({
    alter: true, // 这里是问题所在
})
```

#### `alter: true` 的行为特性：
1. **每次启动都会尝试修改表结构**：
   - Sequelize 会比较模型定义与实际数据库结构。
   - 发现差异时会执行 ALTER TABLE 语句。
   - **这包括重建外键约束**。

2. **生产环境危险操作**：
   ```sql
   -- Sequelize 实际执行的 SQL 示例
   ALTER TABLE `blogs` 
   DROP FOREIGN KEY `blogs_ibfk_1`, 
   ADD CONSTRAINT `blogs_ibfk_1` FOREIGN KEY (`categoryId`) 
   REFERENCES `blog_types` (`id`);
   ```

3. **开发环境常见问题**：
   - 每次启动都修改表结构。
   - 可能导致外键重复创建。
   - 数据重置风险（如果结合 `force: true`）。

### 正确解决方案

#### 1. 修改初始化代码（推荐）

```javascript
// 修改同步策略
await sequelize.sync({
    // 移除 alter: true
    // force: true, // 绝对不要在生产环境使用
});

// 替代方案：检查是否需要同步
if (process.env.NODE_ENV === 'development') {
    const isFirstRun = await checkFirstRun(); // 实现自己的检查逻辑
    if (isFirstRun) {
        await sequelize.sync();
        console.log("数据库初始化完成");
    }
} else {
    // 生产环境使用迁移工具
    await runDatabaseMigrations();
}
```

#### 2. 添加首次运行检查函数

```javascript
async function checkFirstRun() {
    try {
        // 检查元数据表是否存在
        const [results] = await sequelize.query(`
            SELECT COUNT(*) AS count 
            FROM information_schema.tables 
            WHERE table_schema = '${sequelize.config.database}'
            AND table_name = 'blog_types'
        `);
        
        return results[0].count === 0;
    } catch (error) {
        // 表不存在时返回 true
        return true;
    }
}
```

#### 3. 生产环境完整方案

```javascript
// 安装迁移工具
npm install sequelize-cli --save-dev

// 初始化配置
npx sequelize-cli init
```

创建迁移文件：
```javascript
// migrations/20230501-create-associations.js
'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.addConstraint('blogs', {
      fields: ['categoryId'],
      type: 'foreign key',
      name: 'fk_blog_category',
      references: {
        table: 'blog_types',
        field: 'id'
      },
      onDelete: 'CASCADE',
      onUpdate: 'CASCADE'
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.removeConstraint(
      'blogs', 
      'fk_blog_category'
    );
  }
};
```

### 优化后的完整代码

```javascript
const sequelize = require("./dbConnect");
const adminModel = require("./model/adminModel");
const bannerModel = require("./model/bannerModel");
const blogTypeModel = require("./model/blogTypeModel");
const blogModel = require("./model/blogModel");
const md5 = require("md5");

// 定义模型关联关系函数
const defineAssociations = () => {
  blogTypeModel.hasMany(blogModel, {
    foreignKey: "categoryId",
    targetKey: "id",
  });

  blogModel.belongsTo(blogTypeModel, {
    foreignKey: "categoryId",
    targetKey: "id",
    as: "category",
  });
};

(async function () {
  // 步骤1: 定义关联关系
  defineAssociations();

  // 步骤2: 条件数据库同步
  if (process.env.NODE_ENV === "development") {
    // 开发环境: 只同步一次
    const tableExists = await sequelize.getQueryInterface().showAllTables();
    if (tableExists.length === 0) {
      await sequelize.sync();
      console.log("数据库表结构已创建");
    }
  } else {
    // 生产环境: 使用迁移工具
    console.log("生产环境请使用迁移工具");
  }

  // 步骤3: 初始化数据（保持不变）
  const adminCount = await adminModel.count();
  if (!adminCount) {
    await adminModel.create({
      loginId: "admin",
      name: "超级管理员",
      loginPwd: md5("123456"),
    });
    console.log("初始化管理员数据完毕...");
  }

  const bannerCount = await bannerModel.count();
  if (!bannerCount) {
    await bannerModel.bulkCreate([
      {
        midImg: "/static/images/bg1_mid.jpg",
        bigImg: "/static/images/bg1_big.jpg",
        title: "塞尔达旷野之息",
        description: "2017年年度游戏，期待续作",
      },
      {
        midImg: "/static/images/bg2_mid.jpg",
        bigImg: "/static/images/bg2_big.jpg",
        title: "塞尔达四英杰",
        description: "四英杰里面你最喜欢的又是谁呢",
      },
      {
        midImg: "/static/images/bg3_mid.jpg",
        bigImg: "/static/images/bg3_big.jpeg",
        title: "日本街道",
        description: "动漫中经常出现的日本农村街道，一份独特的恬静",
      },
    ]);
    console.log("初始化首页标语数据...");
  }

  console.log("数据库准备完成");
})();
```

### 关键修改点总结

1. **移除 `alter: true`**：
   - 避免每次启动都修改数据库结构。
   - 防止外键重复创建。

2. **分离关联定义**：
   - 创建独立的 `defineAssociations()` 函数。
   - 确保关联只定义一次。

3. **添加环境检测**：
   - 开发环境：只在首次运行时创建表。
   - 生产环境：使用迁移工具管理变更。

4. **保持数据初始化逻辑**：
   - 只有在表为空时才插入初始数据。
   - 不影响现有数据。

### 后续维护建议

1. **开发流程**：
   ```bash
   # 初始化数据库
   npm run db:create
   
   # 运行迁移
   npx sequelize-cli db:migrate
   
   # 回滚迁移
   npx sequelize-cli db:migrate:undo
   ```

2. **生产部署**：
   ```bash
   # 在CI/CD流程中添加
   - run: npx sequelize-cli db:migrate
   ```

3. **模型变更流程**：
   1. 创建新迁移文件。
   2. 测试迁移脚本。
   3. 部署到生产环境。
   4. 执行迁移命令。

这样修改后，将只在首次运行时创建数据库结构和外键，后续启动不会尝试修改表结构，从而避免外键重复创建的问题。。
